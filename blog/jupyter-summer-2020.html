<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  JupyterTeam Progress Summer 2020 | Bicycle Laboratorium
</title>
  <link rel="canonical" href="https://mechmotum.github.io/blog/jupyter-summer-2020.html">


  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/fontawesome.min.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/theme.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/origtheme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://mechmotum.github.io/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://mechmotum.github.io/feeds/education.atom.xml">  
  <meta name="description" content="Blog post on the progress made by JupyterTeam over the summer of 2020">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="https://mechmotum.github.io/">
        <img class="site-image img-fluid rounded" src=https://objects-us-east-1.dream.io/mechmotum/bear-bicycle-transparent-480x480.png alt="Bicycle Laboratorium">
      </a>
    </div>
  <div class="col-sm-8">
    <img src=https://objects-us-east-1.dream.io/mechmotum/tu-delft-logo-233x100.png height=100px>
    <h1 class="title"><a href="https://mechmotum.github.io/">Bicycle Laboratorium</a></h1>
      <p class="text-muted">E pur si muove</p>
      <ul class="list-inline">
            <li class="list-inline-item"><a href="https://mechmotum.github.io/">About</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/members.html">Members</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/research.html">Research</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/products.html">Products</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/jobs.html">Positions</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/guide.html">Guide</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/contact.html">Contact</a></li>
          <li class="list-inline-item"><a href="/blog/">Blog</a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  JupyterTeam Progress Summer 2020
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2020-10-13T00:00:00-07:00">
          <i class="fas fa-clock"></i>
          Tue 13 October 2020
        </li>
        <li class="list-inline-item">
          <i class="fas fa-folder-open"></i>
          <a href="https://mechmotum.github.io/category/education.html">education</a>
        </li>
          <li class="list-inline-item">
            <i class="fas fa-user"></i>
              <a href="https://mechmotum.github.io/author/lyla-sanders.html">Lyla Sanders</a>,               <a href="https://mechmotum.github.io/author/kevin-rong.html">Kevin Rong</a>          </li>
          <li class="list-inline-item">
            <i class="fas fa-tag"></i>
              <a href="https://mechmotum.github.io/tag/oer.html">#oer</a>,               <a href="https://mechmotum.github.io/tag/education.html">#education</a>,               <a href="https://mechmotum.github.io/tag/jupyter.html">#jupyter</a>,               <a href="https://mechmotum.github.io/tag/textbooks.html">#textbooks</a>,               <a href="https://mechmotum.github.io/tag/engineering.html">#engineering</a>,               <a href="https://mechmotum.github.io/tag/libretexts.html">#libretexts</a>          </li>
      </ul>
    </header>


    <div class="content">
      <div class="section" id="summary">
<h2>Summary</h2>
<p>Over the summer sessions of 2020, the JupyterTeam was able to
restructure the default-env image used by our <a class="reference external" href="https://jupyter.libretexts.org/hub/login">JupyterHub
deployment</a> so that it is
built by
<a class="reference external" href="https://repo2docker.readthedocs.io/en/latest/">repo2docker</a>,
allowing us to finally make use of our own <a class="reference external" href="https://binder.libretexts.org/">Binder
deployment</a> as the backend for the
<a class="reference external" href="https://github.com/LibreTexts/ckeditor-binder-plugin">CKEditor Binder
plugin</a> on
<a class="reference external" href="https://libretexts.org/">Libretexts.org</a>. This resolves the
remaining issues mentioned in the JupyterTeam's <a class="reference external" href="https://mechmotum.github.io/blog/libretexts-jupyter-plugin.html#future">previous blog
post</a>.</p>
<p>Additionally, we began bare-metal development on the new Galaxy
Kubernetes cluster building off of experiences with the first <a class="reference external" href="https://mechmotum.github.io/blog/jupyter-summer-2019.html">flock
cluster</a>
and improving on it. We also made numerous miscallaneous improvements
including a new Grafana alert setup, a more detailed FAQ page for our
JupyterHub as well as completing some much needed cluster upgrades.</p>
</div>
<div class="section" id="default-env-2-0">
<h2>default-env 2.0</h2>
<p>A long standing complication with our previous <a class="reference external" href="https://github.com/LibreTexts/default-env/tree/1.13/rich-default">rich default
default-env</a>
image was that it was built using only a single, cluttered Dockerfile
and environment.yml. This led to the files being <a class="reference external" href="https://github.com/LibreTexts/metalc/issues/121">quite
long</a> and <a class="reference external" href="https://github.com/LibreTexts/metalc/issues/130">difficult
to maintain</a>. One of
the advantages of moving to a <a class="reference external" href="https://github.com/LibreTexts/default-env/tree/2.0.1">repo2docker compatible
environment</a> is
that it separates our image building files into more <a class="reference external" href="https://repo2docker.readthedocs.io/en/latest/config_files.html">logical
parts</a>.
Using repo2docker, we no longer have to include a Dockerfile and our
current environment is able to automate away much of what we previously
had to do using docker commands.</p>
<p>Additionally, the new <a class="reference external" href="https://github.com/LibreTexts/default-env">default-env
2.0</a> is properly equipped
to handle <a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html">custom conda
environments</a>.
Not only does this enable users to install their own persistent packages
on the Hub, but it also permitted us to <a class="reference external" href="https://github.com/LibreTexts/metalc/issues/151">reduce the conda
channels</a> necessary
to build the image down to just conda-forge/defaults and those provided
by repo2docker. Additionally, repo2docker now uses an alternative
dependency solver named <a class="reference external" href="https://github.com/mamba-org/mamba">mamba</a>
which reduces our conda environment build times (one part of the image
building process) down to only a few seconds. We further sought to
improve the maintainability of default-env 2.0 by including only the top
level dependencies for all of our desired packages to avoid listing
redundancies.</p>
<p>Finally, we've fully overhauled the <a class="reference external" href="https://jupyter.libretexts.org/hub/faq">LibreTexts FAQ page for
JupyterHub</a> to explain these
default env changes, provide information on creating conda environments,
and more. A small
<a class="reference external" href="https://github.com/LibreTexts/labextension-libretexts-faq">extension</a>
was added to the JupyterLab interface so that users can directly access
the FAQ through the 'help' tab or in the Jupyter Launcher. To do this,
we consolidated the
<a class="reference external" href="https://github.com/LibreTexts/jupyterhub-templates">jupyter-templates</a>
and <a class="reference external" href="https://github.com/LibreTexts/jupyterhub-images">jupyter-images</a>
repositories into just jupyter-templates, and <em>all</em> html pages are now
jinja templates. You can read more about the specifics from the
jupyter-templates <a class="reference external" href="https://github.com/LibreTexts/jupyterhub-templates/blob/master/README.md">README.md
file</a>.</p>
</div>
<div class="section" id="ckeditor-binder-plugin-and-our-kubernetes-binderhub-deployment">
<h2>CKEditor Binder plugin and our Kubernetes BinderHub deployment</h2>
<p>The <a class="reference external" href="https://github.com/LibreTexts/ckeditor-binder-plugin">CKEditor Binder
plugin</a> helps
provide kernels to executable code cells on Libretexts.org using
<a class="reference external" href="https://github.com/jupyterhub/binderhub">BinderHub</a> as a backend.
While the plugin has been working for a while now and it does enable
JupyterLab-esque features on LibreTexts, the code cells would <a class="reference external" href="https://github.com/LibreTexts/metalc/issues/83">often
take many minutes to load and
execute</a>, if they
ever did at all. Furthermore, Binder uses repo2docker to build images
which meant that we could not use our own default-env repository as the
programming environment. As a result, we had to point CKEditor towards
external repositories where we had no control over the exact packages in
the environment. Two changes were made to fix this; we created
default-env 2.0 as outlined above, and we also brought our BinderHub
Kubernetes deployment into operation.</p>
<p>The improvements of using our own default-env 2.0 and BinderHub in
CKEditor Binder plugin represent a huge benefit for LibreTexts. Now that
we can adjust the packages and kernels provided on LibreTexts with our
default-env 2.0, we can include additional <a class="reference external" href="https://chem.libretexts.org/Courses/Remixer_University/LibreTexts_Construction_Guide/05%3A_Interactive_Elements">interactive
widgets</a>
and exercise greater version control over the programming environment.
Switching to a locally maintained BinderHub allows us to cache the
images which are built by Binder on that node, dramatically increasing
loading speeds when executing code cells on LibreTexts. Pressing &quot;run&quot;
will now take no more than 20 seconds to connect to a Binder provided
kernel whereas before it often took minutes or longer due to the
inconsistent availability of mybinder.org. This drastic decrease in load
times makes the plugin much more accessible for both authors and
readers.</p>
</div>
<div class="section" id="galaxy-cluster">
<h2>Galaxy Cluster</h2>
<p>The primary objectives for the new Galaxy cluster are high availability
and maintainability. Part of how we achieve high availability is by
using <a class="reference external" href="https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md#options-for-software-load-balancing">Keepalived and
HAproxy</a>.</p>
<p>Keepalived runs as a static Kubernetes pod on each control-plane node
and it manages a virtual IP for the kube-apiserver that all of the
Kubernetes worker nodes communicate with. If the control-plane node
currently holding this Keepalived virtual IP goes down, Keepalived will
pass the virtual IP on to one of our remaining control-plane nodes so
that the rest of the Kubernetes cluster can still communicate with the
kube-apiserver.</p>
<p>After Keepalived receives a kube-apiserver request, HAproxy (also
running as a static pod on each control-plane node) will load-balance
the request onto whichever control-plane node is chosen according to a
<a class="reference external" href="https://avinetworks.com/glossary/round-robin-load-balancing/">round robin
algorithm</a>.
If we did not use HAproxy, any kube-apiserver request received through
the Keepalived virtual IP would automatically be routed to that same
control-plane node, leaving the other control-plane nodes to just sit
there and do nothing. Load-balancing with HAproxy takes better advantage
of our available hardware and lowers the kube-apiserver load on any
given node.</p>
<p>To improve the maintainability of this cluster, we use
<a class="reference external" href="https://puppet.com/docs/puppet/6.18/puppet_index.html">Puppet</a> to
setup Kubernetes and administrate our entire bare-metal cluster.
Although there already exists a <a class="reference external" href="https://github.com/puppetlabs/puppetlabs-kubernetes">Puppet module for bootstrapping
Kubernetes</a>, our
high availability setup has specific demands which required a <a class="reference external" href="https://github.com/LibreTexts/protogalaxy">new
Puppet module</a> to be
written. The Protogalaxy Puppet module bootstraps all of the necessary
components for Kubernetes using kubeadm like kubelet, kubelctl, and also
configures Keepalived and HAproxy as static pods. You can read more
about the module on its
<a class="reference external" href="https://github.com/LibreTexts/protogalaxy/blob/master/README.md">README</a>
page.</p>
<p>Finally, we have a <a class="reference external" href="https://github.com/LibreTexts/metalc/blob/master/docs/Galaxy-Control-Repo.md">Puppet
control-repo</a>
which employs the ProtoGalaxy module and configures all the
non-Kubernetes components of our Galaxy cluster. Our goal is to use this
control-repo to completely reset the cluster state to a working version
in the case that something massively breaks. This would greatly improve
the maintainability of Galaxy cluster.</p>
<p>As of now, we currently only have a development Galaxy cluster with no
public availability. We repurposed chicks11-18 from the Flock cluster
with brand new SSDs and then booted them up using IPMI. We also used
IPMI to install Ubuntu on all of these nodes because we do not have
physical access to the cluster in the midst of Covid-19.</p>
</div>
<div class="section" id="flock-cluster-upgrades-improvements">
<h2>Flock Cluster Upgrades/Improvements</h2>
<p>At the beginning of summer, the original flock cluster went totally down
because our <a class="reference external" href="https://v1-18.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">kubeadm
certificates</a>
expired. The reason for this was that our cluster was very behind on
Ubuntu and Kubernetes upgrades; the kube-apiserver and kubelet were on
v1.12 while the latest release was v1.18 at the time. One of the first
things we did was to upgrade the flock cluster across all the nodes, and
they now sit at a neat v1.19 for kubelet/kube-apiserver and v18.04.5 for
Ubuntu. Furthermore, we established a policy of upgrading the cluster
every 4 months so that the certificates do not meet their yearly
expiration date as they did before.</p>
<p>Other improvements were made as well. Kubernetes
<a class="reference external" href="https://cert-manager.io/docs/installation/kubernetes/">cert-manager</a>
has been upgraded to v1, and <a class="reference external" href="https://v3.helm.sh/">helm</a> has also
been migrated over to v3. Our Grafana alerts setup has been recrafted so
that we no longer have to manually reinput our dashboards if the pod
goes down. We also enabled IPMI interfaces on all the nodes, affording
us remote adminstration tools in light of Covid-19.</p>
</div>
<div class="section" id="future-plans">
<h2>Future Plans</h2>
<p>Our top priorities moving forward are to enhance the executable code
cell features of LibreTextsand continue development on the Galaxy
cluster. We would like to fix the current issues with ipywidgets and
other interactive plotting features currently exhibited by our CKEditor
Binder plugin. To complement this, we must bring cell-to-cell
communcation to the plugin so that adjusting the output of one cell
(such as a slider) can redraw the output of a previous cell just as it
would in JupyterLab.</p>
<p>For the Galaxy cluster, we need to find a way to read the authentication
process of Hub users so that we can tag their pod and send them to the
high performance computing setup as needed. We will also need to
construct the physical computer setup for Galaxy, just as was done for
Flock cluster over a year ago. Stay tuned for more updates!</p>
</div>

    </div>
  </article>
  <hr>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'https://mechmotum.github.io/blog/jupyter-summer-2020.html';
      this.page.identifier = 'jupyter-summer-2020';
    };
    (function() {
      var d = document;
      var s = d.createElement('script');
      s.src = '//mechmotum.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript class="text-muted">
    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="https://mechmotum.github.io/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="https://mechmotum.github.io/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://mechmotum.github.io/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="https://mechmotum.github.io/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy"
         target="_blank">&#x2728;</a>
    | Edit on <a href="https://github.com/mechmotum/mechmotum.github.io" target="_blank"><i class="fab fa-github"></i></a>
  </p>
</div>
<div class="row">
  <div class="col-sm-4 mx-auto text-center text-muted" >
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
    </a>
    <br />
    This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
  </div>
</div>    </div>
  </footer>

</body>

</html>