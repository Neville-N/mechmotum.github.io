<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Design of a PID Controller for Controlling The Speed of an Instrumented Ebike | Bicycle Laboratorium
</title>
  <link rel="canonical" href="https://mechmotum.github.io/blog/ebike-controller-design.html">


  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/fontawesome.min.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/theme.css">
  <link rel="stylesheet" href="https://mechmotum.github.io/theme/css/origtheme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://mechmotum.github.io/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://mechmotum.github.io/feeds/research.atom.xml">  
  <meta name="description" content="Blog post on designing a speed controller for an instrumented ebike.">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="https://mechmotum.github.io/">
        <img class="site-image img-fluid rounded" src=https://objects-us-east-1.dream.io/mechmotum/bear-bicycle-transparent-480x480.png alt="Bicycle Laboratorium">
      </a>
    </div>
  <div class="col-sm-8">
    <img src=https://objects-us-east-1.dream.io/mechmotum/tu-delft-logo-233x100.png height=100px>
    <h1 class="title"><a href="https://mechmotum.github.io/">Bicycle Laboratorium</a></h1>
      <p class="text-muted">E pur si muove</p>
      <ul class="list-inline">
            <li class="list-inline-item"><a href="https://mechmotum.github.io/">About</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/members.html">Members</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/research.html">Research</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/products.html">Products</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/jobs.html">Positions</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/guide.html">Guide</a></li>
            <li class="list-inline-item"><a href="https://mechmotum.github.io/contact.html">Contact</a></li>
          <li class="list-inline-item"><a href="/blog/">Blog</a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Design of a PID Controller for Controlling The Speed of an Instrumented Ebike
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2018-12-15T00:00:00-08:00">
          <i class="fas fa-clock"></i>
          Sat 15 December 2018
        </li>
        <li class="list-inline-item">
          <i class="fas fa-folder-open"></i>
          <a href="https://mechmotum.github.io/category/research.html">research</a>
        </li>
          <li class="list-inline-item">
            <i class="fas fa-user"></i>
              <a href="https://mechmotum.github.io/author/trevor-metz.html">Trevor Metz</a>          </li>
          <li class="list-inline-item">
            <i class="fas fa-tag"></i>
              <a href="https://mechmotum.github.io/tag/controls.html">#controls</a>,               <a href="https://mechmotum.github.io/tag/instrumentation.html">#instrumentation</a>,               <a href="https://mechmotum.github.io/tag/engineering.html">#engineering</a>,               <a href="https://mechmotum.github.io/tag/mechatronics.html">#mechatronics</a>,               <a href="https://mechmotum.github.io/tag/bicycle.html">#bicycle</a>          </li>
      </ul>
    </header>


    <div class="content">
      <div class="section" id="introduction">
<h2>Introduction</h2>
<p>The goal of this project is to design and implement a control system for an
instrumented ebike used in bicycle handling experimentation. To achieve this, a
basic unity feedback control architecture (Figure 1) is employed.</p>
<div class="figure align-center">
<img alt="Control Architecture." src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-01.jpg" style="width: 80%;" />
<p class="caption"><em>Figure 1. Control architecture where e is the error between the actual
speed v of the ebike and the desired speed, vd, and V is the DC input
voltage to the ebike plant model. Gc and Gp represent the controller and
plant model respectively.</em></p>
</div>
<p>The goal of the controller is to track a setpoint speed, within +/- 0.10 m/s,
set by the rider.  To achieve this, a PID controller was tuned using MATLAB’s
Control System Toolbox. The ebike plant model was derived using first
principles and grey box system identification.</p>
</div>
<div class="section" id="modeling-the-ebike-from-first-principles">
<h2>Modeling the eBike From First Principles</h2>
<p>The dynamics of the ebike powertrain and the vehicle itself can be modeled from
first principles. The powertrain of the ebike consists of a standard ebike
conversion kit motor controller and a brushless 3 phase direct drive induction
motor mounted to the rear hub of the bike. A simple diagram of the ebike
drivetrain is shown below in Figure 2.</p>
<div class="figure align-center">
<img alt="Ebike Drivetrain Diagram." src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-02.jpg" style="width: 80%;" />
<p class="caption"><em>Figure 2. Diagram of the drivetrain circuit and dynamics.</em></p>
</div>
<p>In Figure 2, the induction motor is approximated by a model of a DC motor
circuit with resistance <span class="math">\(R\)</span>, inductance <span class="math">\(L\)</span> and back emf
<span class="math">\(V_b\)</span>. The torques <span class="math">\(T_m\)</span> and <span class="math">\(T_p\)</span> acting on the motor shaft
correspond to motor torque and wheel propulsion torque respectively. The
rotational dynamics of the drivetrain are defined by Euler’s rotation equation.</p>
<p>A simple equation of motion for the bicycle, modeled as a point mass, is
derived using Newton’s 2nd Law of Motion in the horizontal direction <a class="citation-reference" href="#wilson" id="citation-reference-1">[Wilson]</a>.</p>
<div class="figure align-center">
<img alt="Free Body Diagram of Bicycle." src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-03.jpg" style="width: 20%;" />
<p class="caption"><em>Figure 3. Free body diagram of the bicycle modeled as a point mass. Fa, Fr
and Fp are the aerodynamic drag, rolling resistance and propulsive forces
respectively.</em></p>
</div>
<p>Together, the vehicle and drivetrain dynamics of the ebike can be shown in a
state space representation with state variables <span class="math">\(i(t)\)</span> and <span class="math">\(x(t)\)</span>
as seen below.</p>
<img alt="State Space Representation of the eBike." class="align-center" src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-04.jpg" style="width: 55%;" />
<p>From the state space representation, a transfer function from input DC voltage
<span class="math">\(V\)</span> to output speed <span class="math">\(v\)</span> is formed:</p>
<img alt="Plant Model Transfer Function." class="align-center" src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-05.jpg" style="width: 80%;" />
<p>This plant model is a second order transfer function relating an applied DC
voltage input to the ebike’s motor controller to the output speed of the ebike.
This model represents an approximation of the true plant model of the ebike. To
get a more accurate plant model, a grey box system identification procedure
based on measured time response data from the ebike was used.</p>
</div>
<div class="section" id="performing-system-identification-from-experimental-data">
<h2>Performing System Identification From Experimental Data</h2>
<p>To begin the process of system identification, the values of the ebike
drivetrain model parameters and bicycle drag and tire rolling resistance
coefficients were initialized using reasonable approximations found from
internet searches, previous knowledge of the instrumented ebike <a class="citation-reference" href="#moore" id="citation-reference-2">[Moore]</a> and
textbook resources <a class="citation-reference" href="#wilson" id="citation-reference-3">[Wilson]</a>.</p>
<p>In MATLAB, a nonlinear least-squares solver was used to optimize the constants
in the derived plant model of the ebike to match a speed time response measured
from the instrumented ebike. Figure 4, below, shows the curve fitting result.</p>
<div class="figure align-center">
<img alt="Curve Fitting Results." src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-06.jpg" style="width: 80%;" />
<p class="caption"><em>Figure 4. Result of the least-squares curve fitting.</em></p>
</div>
<p>Figure 4 shows that the plant model of ebike was reasonably identified using
the least-squares curve fitting method. The resulting ebike plant model is:</p>
<img alt="Identified Plant Model." class="align-center" src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-07.jpg" style="width: 90%;" />
</div>
<div class="section" id="controller-design-in-matlab">
<h2>Controller Design in MATLAB</h2>
<p>With the plant model of the ebike identified, a PID controller (kp = 68.5, ki =
106, kd = 1.44) was tuned for zero steady state error and reasonable transient
behavior using MATLAB’s Control System Toolbox.</p>
<p>The closed loop step response (Figure 5) shows that the controller meets the
design goals with zero steady state error, a settling time of 1.56s, and an
overshoot percentage of 10.45%.</p>
<div class="figure align-center">
<img alt="Closed Loop System Step Response." src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-08.jpg" style="width: 80%;" />
<p class="caption"><em>Figure 5. Closed Loop System Step Response.</em></p>
</div>
</div>
<div class="section" id="evaluation-of-controller-robustness">
<h2>Evaluation of Controller Robustness</h2>
<p>MATLAB’s Robust Control Toolbox was used to test the robustness of the closed
loop system with regards to uncertainties in the coefficients of the identified
ebike plant model. The constants in the derived ebike plant model were lumped
together forming the following simplified plant model:</p>
<img alt="Simplified Plant Model." class="align-center" src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-09.jpg" style="width: 90%;" />
<p>The constants <span class="math">\(a\)</span>, <span class="math">\(b\)</span>, <span class="math">\(c\)</span>, and <span class="math">\(d\)</span> in the above
transfer function were defined in MATLAB as real-uncertain parameters with
varying percentage based uncertainties about their nominal values. The nominal
values of each coefficient were taken from the result of the system
identification step of the controller design process.  Figure 6, below, shows
the nominal closed loop and open loop system step response with 20 random
samples of the uncertain plant model defined by the uncertain coefficients.</p>
<div class="figure align-center">
<img alt="Uncertain Step Response." src="https://objects-us-east-1.dream.io/mechmotum/bike-speed-control-10.jpg" style="width: 80%;" />
<p class="caption"><em>Figure 6. Step response of the nominal closed loop system with 20 random
samples of the uncertain closed loop step response superimposed on the
plot.</em></p>
</div>
<p>Figure 6 shows that the closed loop system is reasonably robust despite
uncertainty in the plant model. Having this robustness in the control system
means that small changes in the dynamics of the ebike will not cause the
controller to have undesirable performance.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>A simple PID controller used in a unity feedback control architecture was
designed to reduce the steady state error and improve the transient performance
of the speed time response of an instrumented ebike. Using grey box system
identification, the plant model of the ebike was identified and used in the
controller design. A PID tuner app was used to tune the controller constants to
achieve zero steady state gain and favorable transient behavior. Finally, the
robustness of the controller was tested by simulating uncertainties in the
closed loop system.</p>
<p>The next step in the project is to take the continuous time PID controller and
implement it digitally on the instrumented ebike. Stay tuned for part two:
Implementing a PID Controller on an Instrumented Ebike.</p>
</div>
<div class="section" id="references">
<h2>References</h2>
<table class="docutils citation" frame="void" id="wilson" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[Wilson]</td><td><em>(<a class="fn-backref" href="#citation-reference-1">1</a>, <a class="fn-backref" href="#citation-reference-3">2</a>)</em> Wilson, D., Papadopoulos, J. and Whitt, F. (2004). Bicycling science.
Cambridge, Mass.: MIT Press.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="moore" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#citation-reference-2">[Moore]</a></td><td>Moore, J. (2012). Human Control of a Bicycle.
Available at: <a class="reference external" href="http://moorepants.github.io/dissertation/davisbicycle.html">http://moorepants.github.io/dissertation/davisbicycle.html</a>
[Accessed 12 Dec. 2018].</td></tr>
</tbody>
</table>
</div>
<script type='text/javascript'>if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
    </div>
  </article>
  <hr>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'https://mechmotum.github.io/blog/ebike-controller-design.html';
      this.page.identifier = 'ebike-controller-design';
    };
    (function() {
      var d = document;
      var s = d.createElement('script');
      s.src = '//mechmotum.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript class="text-muted">
    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="https://mechmotum.github.io/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="https://mechmotum.github.io/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="https://mechmotum.github.io/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="https://mechmotum.github.io/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy"
         target="_blank">&#x2728;</a>
    | Edit on <a href="https://github.com/mechmotum/mechmotum.github.io" target="_blank"><i class="fab fa-github"></i></a>
  </p>
</div>
<div class="row">
  <div class="col-sm-4 mx-auto text-center text-muted" >
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
    </a>
    <br />
    This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
  </div>
</div>    </div>
  </footer>

</body>

</html>